var roi_0 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[112.99685695666736, -7.601959891428382],
          [112.99685695666736, -7.662189692205628],
          [113.05556514758533, -7.662189692205628],
          [113.05556514758533, -7.601959891428382]]], null, false),
    roi_0_sg = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[113.00252178210681, -7.607830115035795],
           [113.00252178210681, -7.6139554828191285],
           [113.01488140124744, -7.6139554828191285],
           [113.01488140124744, -7.607830115035795]]],
         [[[113.02020290393298, -7.607830115035795],
           [113.02020290393298, -7.614295778463285],
           [113.03410747546619, -7.614295778463285],
           [113.03410747546619, -7.607830115035795]]],
         [[[113.03788402575915, -7.607830115035795],
           [113.03788402575915, -7.614636073837259],
           [113.05264690417712, -7.614636073837259],
           [113.05264690417712, -7.607830115035795]]],
         [[[113.01522472400134, -7.617358427100882],
           [113.01522472400134, -7.624504522098134],
           [113.02466609973376, -7.624504522098134],
           [113.02466609973376, -7.617358427100882]]],
         [[[113.03290584582751, -7.617528573605549],
           [113.03290584582751, -7.623823946760762],
           [113.04200389880603, -7.623823946760762],
           [113.04200389880603, -7.617528573605549]]]], null, false),
    roi_0_xyz = ee.FeatureCollection("projects/ee-hail-daffa/assets/grati_xyz"),
    roi_1 = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[113.2339592007639, -7.709314679738619],
          [113.20687558782659, -7.680618252686616],
          [113.17961651989074, -7.7028029957203925],
          [113.20613203799492, -7.734671087501091]]]),
    roi_1_sg = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[113.18950856477073, -7.698750711449039],
           [113.18950856477073, -7.703343765692603],
           [113.19577420502952, -7.703343765692603],
           [113.19577420502952, -7.698750711449039]]],
         [[[113.19706166535667, -7.693647259468759],
           [113.19706166535667, -7.698495540309138],
           [113.20332730561546, -7.698495540309138],
           [113.20332730561546, -7.693647259468759]]],
         [[[113.20367062836937, -7.6886713359589045],
           [113.20367062836937, -7.692243800704381],
           [113.20890630036644, -7.692243800704381],
           [113.20890630036644, -7.6886713359589045]]]], null, false),
    roi_1_xyz = ee.FeatureCollection("projects/ee-hail-daffa/assets/mayangan_xyz"),
    roi_2 = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[113.2583087073562, -7.739630364695468],
          [113.26972418892359, -7.752812721781175],
          [113.29161101448511, -7.73724899169504],
          [113.27873641121363, -7.724576459284456]]]),
    roi_2_sg = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[113.27636841217253, -7.727724529259857],
           [113.27636841217253, -7.731381714830051],
           [113.2798016397116, -7.731381714830051],
           [113.2798016397116, -7.727724529259857]]],
         [[[113.28091743866179, -7.731636866129194],
           [113.28091743866179, -7.735719265932063],
           [113.28435066620085, -7.735719265932063],
           [113.28435066620085, -7.731636866129194]]],
         [[[113.2852948037741, -7.735549166729],
           [113.2852948037741, -7.738781039855357],
           [113.2885563699362, -7.738781039855357],
           [113.2885563699362, -7.735549166729]]]], null, false),
    roi_2_xyz = ee.FeatureCollection("projects/ee-hail-daffa/assets/dringu_xyz"),
    roi_3 = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[113.81123649020981, -7.708755394950293],
          [113.85140525241684, -7.683068002791737],
          [113.8409339084227, -7.666906264142966],
          [113.7999068393309, -7.694465911895346]]]),
    roi_3_sg = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[113.80513595903997, -7.693540952146658],
           [113.80513595903997, -7.6965179740137755],
           [113.81183075274114, -7.6965179740137755],
           [113.81183075274114, -7.693540952146658]]],
         [[[113.81423401201849, -7.687331667875288],
           [113.81423401201849, -7.689288027518338],
           [113.82110046709661, -7.689288027518338],
           [113.82110046709661, -7.687331667875288]]],
         [[[113.82221626604681, -7.681462534854999],
           [113.82221626604681, -7.6835039816276725],
           [113.83011268938665, -7.6835039816276725],
           [113.83011268938665, -7.681462534854999]]],
         [[[113.83191513384466, -7.675338135684353],
           [113.83191513384466, -7.677549734454599],
           [113.84281563128118, -7.677549734454599],
           [113.84281563128118, -7.675338135684353]]]], null, false),
    roi_3_xyz = ee.FeatureCollection("projects/ee-hail-daffa/assets/pasirputih_xyz"),
    roi_4 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[114.42870518982994, -8.040571636981062],
          [114.42870518982994, -8.063857381284912],
          [114.45651433289635, -8.063857381284912],
          [114.45651433289635, -8.040571636981062]]], null, false),
    roi_4_sg = 
    /* color: #98ff00 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.MultiPolygon(
        [[[[114.45097825349052, -8.041778402856197],
           [114.45097825349052, -8.046027713456501],
           [114.45501229584892, -8.046027713456501],
           [114.45501229584892, -8.041778402856197]]],
         [[[114.44505593598564, -8.048237337364409],
           [114.44505593598564, -8.053591376087509],
           [114.44977662385185, -8.053591376087509],
           [114.44977662385185, -8.048237337364409]]],
         [[[114.44874665559013, -8.056480827894752],
           [114.44874665559013, -8.061154897440694],
           [114.452866528637, -8.061154897440694],
           [114.452866528637, -8.056480827894752]]]], null, false),
    roi_4_xyz = ee.FeatureCollection("projects/ee-hail-daffa/assets/bangsring_xyz");

/*
Algorithm: Stumpf

ROI code (roi_):
0: Grati
1: Mayangan
2: Dringu
3: Pasir Putih
4: Bangsring
*/

/*
Algorithm: Stumpf

ROI code (roi_): 
0: Grati
1: Mayangan
2: Dringu
3: Pasir Putih
4: Bangsring
*/

//Values to be entered
var ROI = 1; //Enter ROI code
var DateStart = ee.Date.fromYMD(2016, 1, 1); //Starting date input
var DateEnd = ee.Date.fromYMD(2016, 3, 31); //Ending Date input

//If algorithms for value
var geom_roi = ee.Algorithms.If(ee.Number(ROI).eq(0), roi_0,
               ee.Algorithms.If(ee.Number(ROI).eq(1), roi_1,
               ee.Algorithms.If(ee.Number(ROI).eq(2), roi_2,
               ee.Algorithms.If(ee.Number(ROI).eq(3), roi_3,
               ee.Algorithms.If(ee.Number(ROI).eq(4), roi_4
               )))));
var sg_s_roi = ee.Algorithms.If(ee.Number(ROI).eq(0), roi_0_sg, 
               ee.Algorithms.If(ee.Number(ROI).eq(1), roi_1_sg,
               ee.Algorithms.If(ee.Number(ROI).eq(2), roi_2_sg,
               ee.Algorithms.If(ee.Number(ROI).eq(3), roi_3_sg,
               ee.Algorithms.If(ee.Number(ROI).eq(4), roi_4_sg
               )))));
var real_roi = ee.Algorithms.If(ee.Number(ROI).eq(0), roi_0_xyz, 
               ee.Algorithms.If(ee.Number(ROI).eq(1), roi_1_xyz,
               ee.Algorithms.If(ee.Number(ROI).eq(2), roi_2_xyz,
               ee.Algorithms.If(ee.Number(ROI).eq(3), roi_3_xyz,
               ee.Algorithms.If(ee.Number(ROI).eq(4), roi_4_xyz
               )))));
var z_roi = ee.Algorithms.If(ee.Number(ROI).eq(0), 'depth', 'z');

//Values
var geom = ee.Geometry(geom_roi); //Geometry input
var sg_sample = ee.Geometry(sg_s_roi); //Make a geometry on deep water areas for sun glint correction 
var real = real_roi; //Insitu data input
var z = z_roi; //Column title for depth or z in insitu data

//Center Map
Map.centerObject(geom, 13.5);

//bitWise function
var bitwiseExtract = function(input, fromBit, toBit) {
  var maskSize = ee.Number(1).add(toBit).subtract(fromBit);
  var mask = ee.Number(1).leftShift(maskSize).subtract(1);
  return input.rightShift(fromBit).bitwiseAnd(mask);
};

//Masking function
function mask(img){
  var qa = img.select('QA_PIXEL');
  
  var dcBitMask = bitwiseExtract(qa, 1, 1).eq(0);   //Dilated Cloud
  var ccBitMask = bitwiseExtract(qa, 3, 3).eq(0);   //Cloud Mask
  var csBitMask = bitwiseExtract(qa, 4, 4).eq(0);   //Cloud Shadow Mask
  var wtrBitMask = bitwiseExtract(qa, 7, 7).eq(1);  //Water Mask
  var maskCombine = dcBitMask.and(ccBitMask).and(csBitMask).and(wtrBitMask);
  
  maskCombine = maskCombine.focalMin({kernel: ee.Kernel.circle({radius: 1}), iterations: 1});
  img = img.mask(maskCombine);
  
  img = img.updateMask(img.select(['B3']).gt(ee.Number(5500)));
  img = img.updateMask(img.select(['B5']).lt(ee.Number(6500)));

  return img;
}

//Set the filter input data to landsat 8 data
var l8nol = ee.ImageCollection('LANDSAT/LC08/C02/T1').filter(ee.Filter.bounds(geom));
//var l8 = l8nol.map(applyScaleFactors);

//Set up the date range and filter
var l8 = l8nol.filter(ee.Filter.date(DateStart, DateEnd));
print(l8);

//Geometric RMSE Model
print('Geometric RMSE Model:', l8.aggregate_mean('GEOMETRIC_RMSE_MODEL'));

//Run the mask function
l8 = l8.map(mask);

//Get the median value of it
var median = l8.reduce(ee.Reducer.median()).clip(geom);

//Convert DN
function convert(img){
  var l8_b2 = (img.select('B2_median').multiply(l8.aggregate_mean('REFLECTANCE_MULT_BAND_2')))
              .add(l8.aggregate_mean('REFLECTANCE_ADD_BAND_2'));
  var l8_b3 = (img.select('B3_median').multiply(l8.aggregate_mean('REFLECTANCE_MULT_BAND_3')))
              .add(l8.aggregate_mean('REFLECTANCE_ADD_BAND_3'));
  var l8_b5 = (img.select('B5_median').multiply(l8.aggregate_mean('REFLECTANCE_MULT_BAND_5')))
              .add(l8.aggregate_mean('REFLECTANCE_ADD_BAND_5'));
  img = ee.Image([l8_b2, l8_b3, l8_b5]);
  
  return img;
}
median = convert(median);

//Deglinting
function deglint(img){
  var nir_b2 = img.select(['B5_median', 'B2_median']).reduceRegion({
      reducer: ee.Reducer.linearFit(),
      geometry: sg_sample,
      scale: 30
      }).get('scale');
  var nir_b3 = img.select(['B5_median', 'B3_median']).reduceRegion({
      reducer: ee.Reducer.linearFit(),
      geometry: sg_sample,
      scale: 30
      }).get('scale');
  
  var slopeDict = ee.Dictionary({
    'b2' : nir_b2,
    'b3' : nir_b3
  }).toImage();
      
  var minNir = img.select(['B5_median']).reduceRegion({
    reducer: ee.Reducer.min(), 
    geometry: sg_sample,
    scale:30
  }).toImage();
  
  return img.select(['B2_median', 'B3_median'])
         .subtract(slopeDict.multiply((img.select(['B5_median']).subtract(minNir))));
}
median = deglint(median);

//Calculate the formula
function depth_calc(img){
  var bigrrs = img.divide(ee.Number(3.14159));
  var rrsvec_bot = (bigrrs.multiply(ee.Number(1.7))).add(ee.Number(0.52));
  var rrsvec = bigrrs.divide(rrsvec_bot);
  var rrsvec1k = rrsvec.multiply(ee.Number(10000));
  var lnrrsvec = rrsvec1k.log();
  
  var depth = (lnrrsvec.select('B2_median')).divide(lnrrsvec.select('B3_median'));
  
  return depth;
}
//Kalkulasi Kedalaman
var depth0 = depth_calc(median);

//In situ Data
var table_img = ee.FeatureCollection(real).reduceToImage({
  properties: [z],
  reducer: ee.Reducer.mean()
});
var img_comb = ee.Image([depth0, table_img]);

//Only (>-20) Data
var table_img_20 = table_img.updateMask(table_img.gte(-20));

//Mobley
//Chla data retrieval
var kloroDate = ee.ImageCollection("JAXA/GCOM-C/L3/OCEAN/CHLA/V2")
                .select(['CHLA_AVE'])
                .filter(ee.Filter.eq('SATELLITE_DIRECTION', 'D'))
                .mean().multiply(0.0016).log10();
var kloroClip = kloroDate.clip(geom);
var kloroR = kloroClip.reduceRegion({
  reducer: ee.Reducer.mean(),
  scale: 30,
  bestEffort: true
}); 
var kloro_if = ee.Algorithms.If(ee.Number(kloroR.get('CHLA_AVE')).lt(2).gt(0), 
               kloroR.get('CHLA_AVE'), '0.5').getInfo();

var chla = kloro_if;
var m0 = ee.Number(52.073 * Math.exp(0.957 * chla));
var m1 = ee.Number(50.156 * Math.exp(0.957 * chla));
print('Chl-a value used:', chla);

var depth_mult = (depth0.multiply(m0)).subtract(m1);
var depthA = depth_mult.where(depth_mult.lt(0), ee.Number(0));
var depth_final = depthA.multiply(-1);

Map.addLayer(depth_final, {min: -20, max: 0, palette: ['0000FF', '00FFFF']}, "Depth (Mobley)");

//Regression
var reg = img_comb.reduceRegion({
      reducer: ee.Reducer.linearFit(),
      geometry: geom,
      scale: 1,
      bestEffort: true
      });

var coef = reg.get('scale');
var res = reg.get('offset');

print('Regression constant used:', 'scale/slpoe', coef, ' ', 'offset/intercept', res);

var depthA_reg = (depth0.multiply(ee.Number(coef))).add(ee.Number(res));
var depth_final_reg = depthA_reg.where(depthA_reg.gt(0), ee.Number(0));

Map.addLayer(depth_final_reg, {min: -20, max: 0, palette: ['0000FF', '00FFFF']}, "Depth (Regression)");

//Export
Export.image.toDrive({
  image: depth_final.clip(geom), 
  description: 'l8_',
  folder: 'Skripsi',
  scale: 1    //meter per pixel
});

//Add layer for in situ data
Map.addLayer(table_img, {}, "In situ Sounding", false);
Map.addLayer(table_img_20, {}, "In situ Sounding (> -20)", false);

//Validation
//Correlation & R^2
function cor_r2_calc(model, control){
  var img_comb = ee.Image([model, control]);
  var cor = img_comb.reduceRegion({
        reducer: ee.Reducer.pearsonsCorrelation(),
        geometry: geom,
        scale: 1,
        bestEffort: true
        });
  var r2 = ee.Number(cor.get('correlation')).pow(2);

  return ee.List([cor, r2]);
}

//RMSE
function rmse_calc(model, control){
  var table_count = control.reduceRegion({
        reducer: ee.Reducer.count(),
        geometry: geom,
        scale: 1,
        bestEffort: true
        });
  var pre_rmse = ((model.subtract(control)).pow(2)).reduceRegion({
        reducer: ee.Reducer.sum(),
        geometry: geom,
        scale: 1,
        bestEffort: true
        });
  var rmse_final = (ee.Number(pre_rmse.get('B2_median'))
                   .divide(ee.Number(table_count.get('mean')))).sqrt();
  
  return ee.List([rmse_final, table_count.get('mean')]);
}

//Correlation & R^2
var cor_r2 = cor_r2_calc(depth0, table_img);
var cor_r2_20 = cor_r2_calc(depth0, table_img_20);

//RMSE
var rmse = rmse_calc(depth_final, table_img);
var rmse_20 = rmse_calc(depth_final, table_img_20);
var rmse_r = rmse_calc(depth_final_reg, table_img);
var rmse_20_r = rmse_calc(depth_final_reg, table_img_20);

//Validation Result
print('Validation', 'Count:', rmse.get(1), ' ', 'Correlation:', cor_r2.get(0), ' ', 'R Squared:', cor_r2.get(1), ' ',
      'RMSE (Mobley):', rmse.get(0), ' ', 'RMSE (Reg):', rmse_r.get(0));
print('Validation (> -20)', 'Count:', rmse_20.get(1), ' ', 'Correlation:', cor_r2_20.get(0), ' ', 'R Squared:', cor_r2_20.get(1), ' ',
      'RMSE (Mobley):', rmse_20.get(0), ' ', 'RMSE (Reg):', rmse_20_r.get(0));
